<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>ã‚ªãƒªã‚­ãƒ£ãƒ©ç›¸é–¢å›³ãƒ¡ãƒ¼ã‚«ãƒ¼</title>
  <!-- SEO -->
  <meta name="description" content="ã‚ªãƒªã‚­ãƒ£ãƒ©ã®é–¢ä¿‚æ€§ã‚’å›³ã«ã—ã‚ˆã†ï¼ç”»åƒã‚’è‡ªç”±ã«é…ç½®ã—ã¦ç·šã§ç¹‹ã’ã‚‹ç›¸é–¢å›³ãƒ¡ãƒ¼ã‚«ãƒ¼â™¡">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">

  <!-- OGP -->
  <meta property="og:title" content="ã‚ªãƒªã‚­ãƒ£ãƒ©ç›¸é–¢å›³ãƒ¡ãƒ¼ã‚«ãƒ¼">
  <meta property="og:description" content="ã†ã¡ã®å­ã®é–¢ä¿‚æ€§ã‚’å¯è¦–åŒ–ï¼è‡ªç”±ã«é…ç½®ã—ã¦ç¹‹ã’ã‚‹ç›¸é–¢å›³ãƒ„ãƒ¼ãƒ«â™¡">
  <meta property="og:type" content="website">
  <meta property="og:url" content="https://mofu-mitsu.github.io/orikyara-relationship-chart/">
  <meta property="og:image" content="https://mofu-mitsu.github.io/orikyara-relationship-chart/ogp.png">
  <meta name="twitter:card" content="summary_large_image">

  <!-- ãƒ•ã‚¡ãƒ“ã‚³ãƒ³ -->
  <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>ğŸ’</text></svg>">

  <!-- ãƒ•ã‚©ãƒ³ãƒˆãƒ»ã‚¢ã‚¤ã‚³ãƒ³ -->
  <link href="https://fonts.googleapis.com/css2?family=Zen+Maru+Gothic:wght@500;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

  <style>
    :root {
      --theme-color: #ff9a9e;
      --bg-color: #fff9fb;
      --board-color: #ffffff;
    }

    body {
      font-family: 'Zen Maru Gothic', sans-serif;
      margin: 0;
      padding: 0;
      padding-bottom: 120px;
      background-color: var(--bg-color);
      /* æ–¹çœ¼ç´™ã£ã½ã„èƒŒæ™¯ */
      background-image: 
        linear-gradient(rgba(255, 154, 158, 0.1) 1px, transparent 1px),
        linear-gradient(90deg, rgba(255, 154, 158, 0.1) 1px, transparent 1px);
      background-size: 20px 20px;
      color: #555;
      display: flex;
      flex-direction: column;
      align-items: center;
      touch-action: manipulation;
    }

    h1 {
      text-align: center;
      color: var(--theme-color);
      margin-top: 30px;
      font-size: 1.5rem;
      background: #fff;
      padding: 10px 25px;
      border-radius: 50px;
      border: 3px dashed var(--theme-color);
      box-shadow: 0 4px 0 rgba(0,0,0,0.1);
    }

    /* æ“ä½œãƒ‘ãƒãƒ« */
    .controls {
      width: 95%;
      max-width: 800px;
      background: #fff;
      padding: 15px;
      border-radius: 15px;
      margin-bottom: 15px;
      box-shadow: 0 4px 10px rgba(0,0,0,0.05);
      display: flex;
      flex-wrap: wrap;
      gap: 15px;
      justify-content: center;
      align-items: center;
    }

    .control-group {
      display: flex;
      align-items: center;
      gap: 5px;
      background: #f9f9f9;
      padding: 5px 10px;
      border-radius: 20px;
    }

    .btn {
      padding: 8px 15px;
      border-radius: 20px;
      border: none;
      font-weight: bold;
      cursor: pointer;
      font-family: inherit;
      font-size: 0.9rem;
      color: white;
      transition: transform 0.1s;
      display: flex;
      align-items: center;
      gap: 5px;
    }
    .btn:active { transform: scale(0.95); }

    .btn-add { background: #ffb7c5; }
    .btn-line { background: #a0c4ff; }
    .btn-line.active { background: #5a96ff; box-shadow: inset 0 3px 5px rgba(0,0,0,0.2); }
    .btn-reset { background: #ccc; font-size: 0.8rem; }

    #fileInput { display: none; }
    .file-label {
      background: #ffb7c5;
      color: white;
      padding: 8px 15px;
      border-radius: 20px;
      cursor: pointer;
      font-weight: bold;
      font-size: 0.9rem;
      display: flex;
      align-items: center;
      gap: 5px;
    }
    .file-label:hover { opacity: 0.9; }

    /* ã‚µã‚¤ã‚ºã‚¹ãƒ©ã‚¤ãƒ€ãƒ¼ */
    input[type="range"] {
      width: 80px;
      cursor: pointer;
    }

    /* === ç›¸é–¢å›³ãƒœãƒ¼ãƒ‰ã‚¨ãƒªã‚¢ === */
    #boardContainer {
      width: 95%;
      max-width: 800px;
      height: 600px;
      background: var(--board-color);
      border: 4px solid var(--theme-color);
      border-radius: 20px;
      position: relative;
      overflow: hidden;
      box-shadow: 0 10px 30px rgba(0,0,0,0.1);
      touch-action: none;
    }

    /* SVGãƒ¬ã‚¤ãƒ¤ãƒ¼ */
    #linesSvg {
      width: 100%;
      height: 100%;
      position: absolute;
      top: 0;
      left: 0;
      z-index: 0;
      pointer-events: none;
    }

    /* ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ã‚¢ã‚¤ã‚³ãƒ³ */
    .char-node {
      position: absolute;
      width: 80px; /* åˆæœŸã‚µã‚¤ã‚º */
      display: flex;
      flex-direction: column;
      align-items: center;
      cursor: grab;
      z-index: 10;
      user-select: none;
    }
    .char-node:active { cursor: grabbing; z-index: 20; }

    .char-img-box {
      width: 100%;
      padding-top: 100%; /* æ­£æ–¹å½¢ç¶­æŒ */
      border-radius: 50%;
      border: 3px solid #fff;
      box-shadow: 0 4px 8px rgba(0,0,0,0.2);
      overflow: hidden;
      background: #eee;
      position: relative;
    }
    .char-img-box img {
      position: absolute;
      top: 0; left: 0;
      width: 100%; height: 100%;
      object-fit: cover;
    }
    
    .btn-delete-char {
      position: absolute;
      top: 0;
      right: 0;
      background: #ff6b6b;
      color: white;
      width: 24px;
      height: 24px;
      border-radius: 50%;
      text-align: center;
      line-height: 24px;
      font-size: 14px;
      cursor: pointer;
      display: none;
      z-index: 5;
    }
    .char-node:hover .btn-delete-char { display: block; }

    .char-name {
      background: rgba(255,255,255,0.9);
      padding: 2px 8px;
      border-radius: 10px;
      font-size: 0.8rem;
      margin-top: 5px;
      font-weight: bold;
      border: 1px solid #eee;
      max-width: 150%; /* åå‰ãŒé•·ãã¦ã‚‚ã‚ã‚‹ç¨‹åº¦è¨±å®¹ */
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      text-align: center;
    }

    /* ç·šä¸Šã®ãƒ©ãƒ™ãƒ« */
    .relation-label {
      position: absolute;
      background: #fff;
      border: 1px solid var(--theme-color);
      color: var(--theme-color);
      padding: 2px 8px;
      border-radius: 10px;
      font-size: 0.75rem;
      font-weight: bold;
      transform: translate(-50%, -50%);
      z-index: 5;
      white-space: nowrap;
      cursor: pointer;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    }

    /* ãƒ¢ãƒ¼ãƒ€ãƒ« */
    #relationModal {
      display: none;
      position: fixed;
      top: 0; left: 0; width: 100%; height: 100%;
      background: rgba(0,0,0,0.5);
      z-index: 100;
      justify-content: center;
      align-items: center;
    }
    .modal-content {
      background: #fff;
      padding: 20px;
      border-radius: 20px;
      width: 90%;
      max-width: 350px;
      text-align: center;
    }
    .modal-input {
      width: 100%; margin-bottom: 10px; padding: 8px;
      border: 2px solid #eee; border-radius: 8px; box-sizing: border-box;
    }
    .preset-btns {
      display: flex; gap: 5px; flex-wrap: wrap; justify-content: center; margin-bottom: 15px;
    }
    .preset-btn {
      background: #f0f0f0; border: none; padding: 5px 10px; border-radius: 15px; cursor: pointer; font-size: 0.8rem;
    }
    
    /* çŸ¢å°ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ */
    .checkbox-wrapper {
      margin-bottom: 15px;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 5px;
      font-weight: bold;
      color: #555;
    }
    .checkbox-wrapper input {
      width: 18px; height: 18px; cursor: pointer;
    }

    /* ä¿å­˜ãƒ»å…±æœ‰ã‚¨ãƒªã‚¢ */
    .save-share-area {
      margin-top: 20px;
      text-align: center;
      display: flex;
      gap: 15px;
      justify-content: center;
    }
    #longpressSaveArea { display: none; margin-top: 20px; text-align: center; }

    /* ãƒ•ãƒƒã‚¿ãƒ¼ */
    .ad-footer {
      text-align: center;
      padding: 20px;
      background: #fff;
      border-top: 3px dashed var(--theme-color);
      margin-top: 40px;
      width: 100%;
    }
    .footer-nav {
      position: fixed;
      bottom: 0; left: 0; width: 100%;
      background: rgba(255,255,255,0.95);
      padding: 12px;
      text-align: center;
      z-index: 999;
      box-shadow: 0 -2px 10px rgba(0,0,0,0.05);
      border-top: 2px solid var(--theme-color);
    }
    .footer-nav a { color: var(--theme-color); font-weight: bold; text-decoration: none; }

    /* é¸æŠä¸­ã®ã‚¹ã‚¿ã‚¤ãƒ« */
    .char-node.selected .char-img-box {
      border-color: #5a96ff;
      box-shadow: 0 0 15px rgba(90, 150, 255, 0.6);
    }

  </style>
</head>
<body>

  <h1>ğŸ§© ã‚ªãƒªã‚­ãƒ£ãƒ©ç›¸é–¢å›³ãƒ¡ãƒ¼ã‚«ãƒ¼</h1>

  <div class="controls">
    <!-- ç”»åƒè¿½åŠ ãƒœã‚¿ãƒ³ -->
    <label class="file-label">
      <input type="file" id="fileInput" accept="image/*" onchange="addCharacter(this)">
      <i class="fa-solid fa-plus"></i> ã‚­ãƒ£ãƒ©è¿½åŠ 
    </label>

    <!-- ç·šå¼•ããƒ¢ãƒ¼ãƒ‰åˆ‡ã‚Šæ›¿ãˆ -->
    <button class="btn btn-line" id="lineModeBtn" onclick="toggleLineMode()">
      <i class="fa-solid fa-link"></i> é–¢ä¿‚ã‚’çµã¶
    </button>

    <!-- ã‚µã‚¤ã‚ºå¤‰æ›´ã‚¹ãƒ©ã‚¤ãƒ€ãƒ¼ï¼ˆé¸æŠæ™‚ã®ã¿æœ‰åŠ¹ï¼‰ -->
    <div class="control-group">
      <i class="fa-solid fa-up-right-and-down-left-from-center" style="font-size:0.8rem; color:#888;"></i>
      <input type="range" id="sizeSlider" min="50" max="200" value="80" disabled oninput="changeCharSize(this.value)">
    </div>

    <!-- èƒŒæ™¯è‰² -->
    <div class="control-group" style="font-size:0.8rem;">
      èƒŒæ™¯
      <input type="color" id="bgColorPicker" value="#ffffff" onchange="changeBoardColor(this.value)" style="width:25px; height:25px; border:none; cursor:pointer;">
    </div>

    <button class="btn btn-reset" onclick="resetBoard()"><i class="fa-solid fa-trash"></i></button>
  </div>

  <div style="font-size:0.8rem; margin-bottom:5px; color:#888;">
    â€»ã‚­ãƒ£ãƒ©ã‚’ã‚¿ãƒƒãƒ—ã™ã‚‹ã¨ã‚µã‚¤ã‚ºå¤‰æ›´ã§ãã¾ã™
  </div>

  <!-- ç›¸é–¢å›³ãƒœãƒ¼ãƒ‰ -->
  <div id="boardContainer">
    <!-- SVGãƒ¬ã‚¤ãƒ¤ãƒ¼ -->
    <svg id="linesSvg">
      <defs></defs> <!-- ãƒãƒ¼ã‚«ãƒ¼å®šç¾©ç”¨ -->
    </svg>
    <!-- ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼é…ç½®ã‚¨ãƒªã‚¢ -->
  </div>

  <!-- ä¿å­˜ãƒ»å…±æœ‰ -->
  <div class="save-share-area">
    <button class="btn btn-add" id="btn-save" onclick="saveImage()">
      <i class="fa-solid fa-camera"></i> ç”»åƒä¿å­˜
    </button>
    <button class="btn" style="background:#555;" onclick="nativeShare()">
      <i class="fa-solid fa-share-nodes"></i> å…±æœ‰
    </button>
  </div>

  <div id="longpressSaveArea"></div>

  <!-- é–¢ä¿‚å…¥åŠ›ãƒ¢ãƒ¼ãƒ€ãƒ« -->
  <div id="relationModal">
    <div class="modal-content">
      <h3>é–¢ä¿‚æ€§ã‚’å…¥åŠ›</h3>
      <input type="text" id="relationText" class="modal-input" placeholder="ä¾‹ï¼šè¦ªå‹ã€ãƒ©ã‚¤ãƒãƒ«">
      
      <div class="preset-btns">
        <button class="preset-btn" onclick="setInput('è¦ªå‹')">è¦ªå‹</button>
        <button class="preset-btn" onclick="setInput('æ‹äºº')">æ‹äºº</button>
        <button class="preset-btn" onclick="setInput('çŠ¬çŒ¿')">çŠ¬çŒ¿</button>
        <button class="preset-btn" onclick="setInput('å®¶æ—')">å®¶æ—</button>
        <button class="preset-btn" onclick="setInput('ç‰‡æ€ã„')">ç‰‡æ€ã„</button>
      </div>

      <div class="checkbox-wrapper">
        <input type="checkbox" id="arrowCheck">
        <label for="arrowCheck">çŸ¢å°ã‚’ã¤ã‘ã‚‹ (ä¸€æ–¹é€šè¡Œ)</label>
      </div>

      <label style="font-size:0.9rem; font-weight:bold;">ç·šã®è‰²ï¼š</label>
      <input type="color" id="lineColorInput" value="#ffb7c5" style="width:100%; height:40px; margin-bottom:15px; cursor:pointer;">
      
      <div style="display:flex; justify-content:center; gap:10px;">
        <button class="btn btn-add" onclick="confirmRelation()">æ±ºå®š</button>
        <button class="btn btn-reset" onclick="closeModal()">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
      </div>
    </div>
  </div>

  <!-- ãƒ•ãƒƒã‚¿ãƒ¼ -->
  <footer class="ad-footer">
    <p style="color:var(--theme-color); font-weight:bold; margin-bottom:10px;">â™¡ å‰µä½œã®ãŠä¾›ã« â™¡</p>
    <div style="display:flex; justify-content:center; gap:10px; flex-wrap:wrap;">
      <script type="text/javascript">rakuten_design="slide";rakuten_affiliateId="47f67ba0.34b43d0d.47f67ba1.f8c0f51e";rakuten_items="ctsmatch";rakuten_genreId="0";rakuten_size="468x160";rakuten_target="_blank";rakuten_theme="gray";rakuten_border="off";rakuten_auto_mode="on";rakuten_genre_title="off";rakuten_recommend="on";rakuten_ts="1764908023168";</script><script type="text/javascript" src="https://xml.affiliate.rakuten.co.jp/widget/js/rakuten_widget.js?20230106"></script>
    </div>
  </footer>

  <div class="footer-nav">
    <a href="https://mofu-mitsu.github.io/">TOPã¸æˆ»ã‚‹</a>
  </div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <script>
    /* === åŸºæœ¬è¨­å®š === */
    let characters = []; // { id, element }
    let relationships = []; // { id, fromId, toId, text, color, isArrow, markerId }
    let charIdCounter = 0;
    let lineIdCounter = 0;
    
    let isLineMode = false;
    let selectedCharId = null; // ç·šçµã³ãƒ»ã‚µã‚¤ã‚ºå¤‰æ›´ç”¨

    const board = document.getElementById('boardContainer');
    const svg = document.getElementById('linesSvg');
    const defs = svg.querySelector('defs');
    const sizeSlider = document.getElementById('sizeSlider');

    /* === ã‚­ãƒ£ãƒ©è¿½åŠ æ©Ÿèƒ½ === */
    function addCharacter(input) {
      const file = input.files[0];
      if (!file) return;

      const reader = new FileReader();
      reader.onload = function(e) {
        createCharacterNode(e.target.result);
        input.value = ''; 
      };
      reader.readAsDataURL(file);
    }

    function createCharacterNode(imgSrc) {
      charIdCounter++;
      const id = `char-${charIdCounter}`;
      
      const x = Math.random() * (board.clientWidth - 100);
      const y = Math.random() * (board.clientHeight - 100);

      const node = document.createElement('div');
      node.className = 'char-node';
      node.id = id;
      node.style.left = x + 'px';
      node.style.top = y + 'px';
      // åˆæœŸã‚µã‚¤ã‚º
      node.style.width = '80px'; 
      
      const delBtn = document.createElement('div');
      delBtn.className = 'btn-delete-char';
      delBtn.innerText = 'Ã—';
      delBtn.onclick = (ev) => { ev.stopPropagation(); deleteCharacter(id); };

      const imgBox = document.createElement('div');
      imgBox.className = 'char-img-box';
      const img = document.createElement('img');
      img.src = imgSrc;
      imgBox.appendChild(img);

      const nameLabel = document.createElement('div');
      nameLabel.className = 'char-name';
      nameLabel.innerText = 'åå‰å…¥åŠ›';
      nameLabel.onclick = (ev) => {
        ev.stopPropagation();
        if(!isLineMode) {
          const newName = prompt("ã‚­ãƒ£ãƒ©ã®åå‰ã‚’å…¥åŠ›ã—ã¦ã­", nameLabel.innerText);
          if(newName) nameLabel.innerText = newName;
        }
      };

      node.appendChild(delBtn);
      node.appendChild(imgBox);
      node.appendChild(nameLabel);
      board.appendChild(node);

      characters.push({ id, element: node });

      setupDraggable(node);
      
      // ã‚¯ãƒªãƒƒã‚¯ã‚¤ãƒ™ãƒ³ãƒˆï¼ˆé¸æŠãƒ»ç·šçµã³ï¼‰
      node.addEventListener('click', () => handleCharClick(id));
    }

    /* === å‰Šé™¤æ©Ÿèƒ½ === */
    function deleteCharacter(id) {
      const index = characters.findIndex(c => c.id === id);
      if (index > -1) {
        characters[index].element.remove();
        characters.splice(index, 1);
        
        // é–¢é€£ã™ã‚‹ç·šã‚’å‰Šé™¤
        const relatedLines = relationships.filter(r => r.fromId === id || r.toId === id);
        relatedLines.forEach(r => deleteLine(r.id));
      }
      if (selectedCharId === id) {
        selectedCharId = null;
        sizeSlider.disabled = true;
      }
    }

    /* === ã‚µã‚¤ã‚ºå¤‰æ›´æ©Ÿèƒ½ === */
    function changeCharSize(val) {
      if (!selectedCharId) return;
      const el = document.getElementById(selectedCharId);
      if (el) {
        el.style.width = val + 'px';
        updateLines(); // ç·šã‚‚å†è¨ˆç®—
      }
    }

    /* === ãƒ‰ãƒ©ãƒƒã‚°ç§»å‹•æ©Ÿèƒ½ === */
    function setupDraggable(el) {
      let isDragging = false;
      let startX, startY, initialLeft, initialTop;

      const startDrag = (e) => {
        if(isLineMode) return;
        isDragging = true;
        const clientX = e.type.includes('touch') ? e.touches[0].clientX : e.clientX;
        const clientY = e.type.includes('touch') ? e.touches[0].clientY : e.clientY;
        startX = clientX;
        startY = clientY;
        initialLeft = parseFloat(el.style.left || 0);
        initialTop = parseFloat(el.style.top || 0);
        el.style.zIndex = 100;
      };

      const doDrag = (e) => {
        if (!isDragging) return;
        e.preventDefault();
        const clientX = e.type.includes('touch') ? e.touches[0].clientX : e.clientX;
        const clientY = e.type.includes('touch') ? e.touches[0].clientY : e.clientY;
        const dx = clientX - startX;
        const dy = clientY - startY;
        let newLeft = initialLeft + dx;
        let newTop = initialTop + dy;
        const maxW = board.clientWidth - el.offsetWidth;
        const maxH = board.clientHeight - el.offsetHeight;
        newLeft = Math.max(0, Math.min(newLeft, maxW));
        newTop = Math.max(0, Math.min(newTop, maxH));
        el.style.left = newLeft + 'px';
        el.style.top = newTop + 'px';
        updateLines();
      };

      const stopDrag = () => {
        isDragging = false;
        el.style.zIndex = '';
      };

      el.addEventListener('mousedown', startDrag);
      el.addEventListener('touchstart', startDrag, {passive: false});
      window.addEventListener('mousemove', doDrag);
      window.addEventListener('touchmove', doDrag, {passive: false});
      window.addEventListener('mouseup', stopDrag);
      window.addEventListener('touchend', stopDrag);
    }

    /* === ç·šçµã³ & é¸æŠæ©Ÿèƒ½ === */
    function toggleLineMode() {
      isLineMode = !isLineMode;
      const btn = document.getElementById('lineModeBtn');
      deselectAll(); // ãƒ¢ãƒ¼ãƒ‰åˆ‡æ›¿æ™‚ã«é¸æŠè§£é™¤

      if (isLineMode) {
        btn.classList.add('active');
        btn.innerHTML = '<i class="fa-solid fa-check"></i> çµ‚äº†';
        sizeSlider.disabled = true; // ç·šãƒ¢ãƒ¼ãƒ‰ä¸­ã¯ã‚µã‚¤ã‚ºå¤‰æ›´ä¸å¯
      } else {
        btn.classList.remove('active');
        btn.innerHTML = '<i class="fa-solid fa-link"></i> é–¢ä¿‚ã‚’çµã¶';
      }
    }

    function deselectAll() {
      if (selectedCharId) {
        document.getElementById(selectedCharId)?.classList.remove('selected');
        selectedCharId = null;
      }
      sizeSlider.disabled = true;
    }

    let tempFromId = null;
    let tempToId = null;

    function handleCharClick(id) {
      const el = document.getElementById(id);

      if (isLineMode) {
        // --- ç·šçµã³ãƒ¢ãƒ¼ãƒ‰ ---
        if (!selectedCharId) {
          // 1äººç›®
          selectedCharId = id;
          el.classList.add('selected');
        } else {
          // 2äººç›®
          if (selectedCharId !== id) {
            tempFromId = selectedCharId;
            tempToId = id;
            document.getElementById(selectedCharId).classList.remove('selected');
            selectedCharId = null;
            openModal();
          } else {
            // ã‚­ãƒ£ãƒ³ã‚»ãƒ«
            el.classList.remove('selected');
            selectedCharId = null;
          }
        }
      } else {
        // --- é€šå¸¸ãƒ¢ãƒ¼ãƒ‰ï¼ˆã‚µã‚¤ã‚ºå¤‰æ›´ç”¨é¸æŠï¼‰ ---
        if (selectedCharId) {
          document.getElementById(selectedCharId).classList.remove('selected');
        }
        selectedCharId = id;
        el.classList.add('selected');
        
        // ã‚¹ãƒ©ã‚¤ãƒ€ãƒ¼ã‚’ã“ã®ã‚­ãƒ£ãƒ©ã®ã‚µã‚¤ã‚ºã«åˆã‚ã›ã‚‹
        const currentWidth = parseFloat(el.style.width);
        sizeSlider.value = currentWidth;
        sizeSlider.disabled = false;
      }
    }

    /* === ãƒ¢ãƒ¼ãƒ€ãƒ«é–¢é€£ === */
    const modal = document.getElementById('relationModal');
    const relationInput = document.getElementById('relationText');
    const colorInput = document.getElementById('lineColorInput');
    const arrowCheck = document.getElementById('arrowCheck');

    function openModal() {
      relationInput.value = '';
      arrowCheck.checked = false;
      modal.style.display = 'flex';
    }
    
    function closeModal() {
      modal.style.display = 'none';
      tempFromId = null;
      tempToId = null;
    }

    function setInput(text) {
      relationInput.value = text;
    }

    function confirmRelation() {
      const text = relationInput.value || 'é–¢ä¿‚';
      const color = colorInput.value;
      const isArrow = arrowCheck.checked;
      createLine(tempFromId, tempToId, text, color, isArrow);
      closeModal();
    }

    /* === ç·šã®æç”»ãƒ»ç®¡ç† === */
    function createLine(fromId, toId, text, color, isArrow) {
      lineIdCounter++;
      const id = `line-${lineIdCounter}`;
      const markerId = `marker-${lineIdCounter}`;

      // çŸ¢å°ç”¨ãƒãƒ¼ã‚«ãƒ¼ä½œæˆï¼ˆdefsã«è¿½åŠ ï¼‰
      if (isArrow) {
        const marker = document.createElementNS('http://www.w3.org/2000/svg', 'marker');
        marker.setAttribute('id', markerId);
        marker.setAttribute('viewBox', '0 0 10 10');
        marker.setAttribute('refX', '9'); // ç·šã®å…ˆç«¯
        marker.setAttribute('refY', '5');
        marker.setAttribute('markerWidth', '6');
        marker.setAttribute('markerHeight', '6');
        marker.setAttribute('orient', 'auto');
        
        const path = document.createElementNS('http://www.w3.org/2000/svg', 'path');
        path.setAttribute('d', 'M 0 0 L 10 5 L 0 10 z');
        path.setAttribute('fill', color);
        
        marker.appendChild(path);
        defs.appendChild(marker);
      }

      // ç·šä½œæˆ
      const line = document.createElementNS('http://www.w3.org/2000/svg', 'line');
      line.setAttribute('id', id);
      line.setAttribute('stroke', color);
      line.setAttribute('stroke-width', '3');
      line.setAttribute('stroke-linecap', 'round');
      if (isArrow) {
        line.setAttribute('marker-end', `url(#${markerId})`);
      }
      svg.appendChild(line);

      // ãƒ©ãƒ™ãƒ«ä½œæˆ
      const label = document.createElement('div');
      label.className = 'relation-label';
      label.id = 'label-' + id;
      label.innerText = text;
      label.style.borderColor = color;
      label.style.color = color;
      
      label.onclick = () => {
        if(confirm('ã“ã®é–¢ä¿‚ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) {
          deleteLine(id);
        }
      };
      
      board.appendChild(label);

      relationships.push({ id, fromId, toId, text, color, isArrow, markerId, lineEl: line, labelEl: label });
      updateLines();
    }

    function deleteLine(id) {
      const index = relationships.findIndex(r => r.id === id);
      if(index > -1) {
        const rel = relationships[index];
        rel.lineEl.remove();
        rel.labelEl.remove();
        // ãƒãƒ¼ã‚«ãƒ¼ã‚‚å‰Šé™¤
        if(rel.isArrow) {
          const m = document.getElementById(rel.markerId);
          if(m) m.remove();
        }
        relationships.splice(index, 1);
      }
    }

    // ç·šã®ä½ç½®è¨ˆç®—ï¼ˆè¶…é‡è¦ï¼šã‚¢ã‚¤ã‚³ãƒ³ã®ãƒ•ãƒã§æ­¢ã‚ã‚‹ï¼‰
    function updateLines() {
      relationships.forEach(rel => {
        const fromEl = document.getElementById(rel.fromId);
        const toEl = document.getElementById(rel.toId);
        if (!fromEl || !toEl) return;

        // ã‚¢ã‚¤ã‚³ãƒ³ã®ä¸­å¿ƒåº§æ¨™
        const x1_c = fromEl.offsetLeft + fromEl.offsetWidth / 2;
        const y1_c = fromEl.offsetTop + fromEl.offsetHeight / 2;
        const x2_c = toEl.offsetLeft + toEl.offsetWidth / 2;
        const y2_c = toEl.offsetTop + toEl.offsetHeight / 2;

        // ã‚¢ã‚¤ã‚³ãƒ³ã®åŠå¾„ï¼ˆç”»åƒéƒ¨åˆ†ã¯æ­£æ–¹å½¢ãªã®ã§å¹…ã®åŠåˆ†ï¼‰
        // å®Ÿéš›ã«ã¯ char-img-box ã¯ width:100% ãªã®ã§ char-node ã® width/2 ãŒåŠå¾„
        const r1 = fromEl.offsetWidth / 2;
        const r2 = toEl.offsetWidth / 2;

        // ãƒ™ã‚¯ãƒˆãƒ«è¨ˆç®—
        const dx = x2_c - x1_c;
        const dy = y2_c - y1_c;
        const dist = Math.sqrt(dx * dx + dy * dy);

        if (dist === 0) return; // é‡ãªã£ã¦ã‚‹å ´åˆ

        // å§‹ç‚¹ã¨çµ‚ç‚¹ã‚’åŠå¾„åˆ†ãšã‚‰ã™ï¼ˆã‚¢ã‚¤ã‚³ãƒ³ã®ãƒ•ãƒã«åˆã‚ã›ã‚‹ï¼‰
        // çŸ¢å°ãŒã‚ã‚‹å ´åˆã€çµ‚ç‚¹ã¯åŠå¾„+çŸ¢å°ã®å¤§ãã•åˆ†å°‘ã—ä½™è£•ã‚’æŒãŸã›ã‚‹
        const offset2 = rel.isArrow ? r2 + 5 : r2; 

        const startX = x1_c + (dx / dist) * r1;
        const startY = y1_c + (dy / dist) * r1;
        const endX = x2_c - (dx / dist) * offset2;
        const endY = y2_c - (dy / dist) * offset2;

        // ç·šæ›´æ–°
        rel.lineEl.setAttribute('x1', startX);
        rel.lineEl.setAttribute('y1', startY);
        rel.lineEl.setAttribute('x2', endX);
        rel.lineEl.setAttribute('y2', endY);

        // ãƒ©ãƒ™ãƒ«ä½ç½®æ›´æ–°ï¼ˆä¸­ç‚¹ï¼‰
        rel.labelEl.style.left = (startX + endX) / 2 + 'px';
        rel.labelEl.style.top = (startY + endY) / 2 + 'px';
      });
    }

    /* === ãã®ä»–æ©Ÿèƒ½ === */
    function changeBoardColor(color) {
      document.getElementById('boardContainer').style.background = color;
    }

    function resetBoard() {
      if(!confirm('å…¨ã¦ãƒªã‚»ãƒƒãƒˆã—ã¾ã™ã‹ï¼Ÿ')) return;
      // SVGã®ä¸­èº«ï¼ˆç·šã¨ãƒãƒ¼ã‚«ãƒ¼ï¼‰ã‚’ã‚¯ãƒªã‚¢
      while (svg.lastChild) {
        svg.removeChild(svg.lastChild);
      }
      // defsã‚’å†ç”Ÿæˆ
      const newDefs = document.createElementNS('http://www.w3.org/2000/svg', 'defs');
      svg.appendChild(newDefs);

      // ã‚­ãƒ£ãƒ©å‰Šé™¤
      characters.forEach(c => c.element.remove());
      // ãƒ©ãƒ™ãƒ«å‰Šé™¤
      relationships.forEach(r => r.labelEl.remove());

      characters = [];
      relationships = [];
      charIdCounter = 0;
      lineIdCounter = 0;
      isLineMode = false;
      selectedCharId = null;
      document.getElementById('lineModeBtn').classList.remove('active');
      document.getElementById('lineModeBtn').innerHTML = '<i class="fa-solid fa-link"></i> é–¢ä¿‚ã‚’çµã¶';
    }

    /* === ä¿å­˜ãƒ»å…±æœ‰ === */
    function saveImage() {
      const btn = document.getElementById('btn-save');
      const originalText = btn.innerHTML;
      btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> ä½œæˆä¸­...';
      
      // é¸æŠçŠ¶æ…‹ã®æ ã‚’ä¸€æ™‚çš„ã«æ¶ˆã™
      const selected = document.querySelector('.selected');
      if(selected) selected.classList.remove('selected');

      html2canvas(document.getElementById('boardContainer'), {
        scale: 2,
        backgroundColor: null
      }).then(canvas => {
        const dataURL = canvas.toDataURL('image/png');
        const isMobile = /iPhone|iPad|iPod|Android/i.test(navigator.userAgent);

        if (isMobile) {
          const area = document.getElementById('longpressSaveArea');
          area.innerHTML = '';
          const img = document.createElement('img');
          img.src = dataURL;
          img.style.width = '100%';
          img.style.borderRadius = '10px';
          img.style.boxShadow = '0 5px 15px rgba(0,0,0,0.1)';
          const msg = document.createElement('p');
          msg.innerHTML = 'â˜ï¸ <strong>ç”»åƒã‚’é•·æŠ¼ã—ã—ã¦ä¿å­˜</strong>ã—ã¦ã­ï¼';
          msg.style.color = '#ff9a9e';
          area.appendChild(msg);
          area.appendChild(img);
          area.style.display = 'block';
          area.scrollIntoView({behavior: 'smooth'});
        } else {
          const link = document.createElement('a');
          link.href = dataURL;
          link.download = `soukanzu-${Date.now()}.png`;
          link.click();
        }
        btn.innerHTML = originalText;
        if(selected) selected.classList.add('selected'); // é¸æŠæˆ»ã™
      });
    }

    function nativeShare() {
      if (navigator.share) {
        navigator.share({
          title: 'ã‚ªãƒªã‚­ãƒ£ãƒ©ç›¸é–¢å›³ãƒ¡ãƒ¼ã‚«ãƒ¼',
          text: 'ã†ã¡ã®å­ã®é–¢ä¿‚æ€§ã‚’ã¾ã¨ã‚ã¾ã—ãŸï¼ #ã‚ªãƒªã‚­ãƒ£ãƒ©ç›¸é–¢å›³ãƒ¡ãƒ¼ã‚«ãƒ¼',
          url: location.href
        });
      } else {
        alert('URLã‚’ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸï¼');
        navigator.clipboard.writeText(location.href);
      }
    }
  </script>
</body>
</html>

<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>ã‚ªãƒªã‚­ãƒ£ãƒ©ç›¸é–¢å›³ãƒ¡ãƒ¼ã‚«ãƒ¼</title>
  <!-- SEO -->
  <meta name="description" content="ã‚ªãƒªã‚­ãƒ£ãƒ©ã®é–¢ä¿‚æ€§ã‚’å›³ã«ã—ã‚ˆã†ï¼ç”»åƒã‚’è‡ªç”±ã«é…ç½®ã—ã¦ç·šã§ç¹‹ã’ã‚‹ç›¸é–¢å›³ãƒ¡ãƒ¼ã‚«ãƒ¼â™¡">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">

  <!-- OGP -->
  <meta property="og:title" content="ã‚ªãƒªã‚­ãƒ£ãƒ©ç›¸é–¢å›³ãƒ¡ãƒ¼ã‚«ãƒ¼">
  <meta property="og:description" content="ã†ã¡ã®å­ã®é–¢ä¿‚æ€§ã‚’å¯è¦–åŒ–ï¼è‡ªç”±ã«é…ç½®ã—ã¦ç¹‹ã’ã‚‹ç›¸é–¢å›³ãƒ„ãƒ¼ãƒ«â™¡">
  <meta property="og:type" content="website">
  <!-- â†“ URLå¤‰æ›´ã—ã¦ã­ -->
  <meta property="og:url" content="https://mofu-mitsu.github.io/orikyara-relationship-chart/">
  <meta property="og:image" content="https://mofu-mitsu.github.io/orikyara-relationship-chart/ogp.png">
  <meta name="twitter:card" content="summary_large_image">

  <!-- ãƒ•ã‚¡ãƒ“ã‚³ãƒ³ -->
  <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>ğŸ’</text></svg>">

  <!-- ãƒ•ã‚©ãƒ³ãƒˆãƒ»ã‚¢ã‚¤ã‚³ãƒ³ -->
  <link href="https://fonts.googleapis.com/css2?family=Zen+Maru+Gothic:wght@500;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

  <style>
    :root {
      --theme-color: #ff9a9e;
      --bg-color: #fff9fb;
      --board-color: #ffffff;
    }

    body {
      font-family: 'Zen Maru Gothic', sans-serif;
      margin: 0;
      padding: 0;
      padding-bottom: 120px;
      background-color: var(--bg-color);
      /* æ–¹çœ¼ç´™ã£ã½ã„èƒŒæ™¯ */
      background-image: 
        linear-gradient(rgba(255, 154, 158, 0.1) 1px, transparent 1px),
        linear-gradient(90deg, rgba(255, 154, 158, 0.1) 1px, transparent 1px);
      background-size: 20px 20px;
      color: #555;
      display: flex;
      flex-direction: column;
      align-items: center;
      touch-action: manipulation; /* ã‚¹ãƒãƒ›ã§ã®æ“ä½œæ€§å‘ä¸Š */
    }

    h1 {
      text-align: center;
      color: var(--theme-color);
      margin-top: 30px;
      font-size: 1.5rem;
      background: #fff;
      padding: 10px 25px;
      border-radius: 50px;
      border: 3px dashed var(--theme-color);
      box-shadow: 0 4px 0 rgba(0,0,0,0.1);
    }

    /* æ“ä½œãƒ‘ãƒãƒ« */
    .controls {
      width: 95%;
      max-width: 800px;
      background: #fff;
      padding: 15px;
      border-radius: 15px;
      margin-bottom: 15px;
      box-shadow: 0 4px 10px rgba(0,0,0,0.05);
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      justify-content: center;
      align-items: center;
    }

    .btn {
      padding: 8px 15px;
      border-radius: 20px;
      border: none;
      font-weight: bold;
      cursor: pointer;
      font-family: inherit;
      font-size: 0.9rem;
      color: white;
      transition: transform 0.1s;
      display: flex;
      align-items: center;
      gap: 5px;
    }
    .btn:active { transform: scale(0.95); }

    .btn-add { background: #ffb7c5; }
    .btn-line { background: #a0c4ff; }
    .btn-line.active { background: #5a96ff; box-shadow: inset 0 3px 5px rgba(0,0,0,0.2); }
    .btn-reset { background: #ccc; font-size: 0.8rem; }

    /* ãƒ•ã‚¡ã‚¤ãƒ«å…¥åŠ›ã¯éš ã—ã¦ãƒ©ãƒ™ãƒ«ã§æ“ä½œ */
    #fileInput { display: none; }
    .file-label {
      background: #ffb7c5;
      color: white;
      padding: 8px 15px;
      border-radius: 20px;
      cursor: pointer;
      font-weight: bold;
      font-size: 0.9rem;
      display: flex;
      align-items: center;
      gap: 5px;
    }
    .file-label:hover { opacity: 0.9; }

    /* === ç›¸é–¢å›³ãƒœãƒ¼ãƒ‰ã‚¨ãƒªã‚¢ === */
    #boardContainer {
      width: 95%;
      max-width: 800px;
      height: 600px; /* ãƒœãƒ¼ãƒ‰ã®é«˜ã• */
      background: var(--board-color);
      border: 4px solid var(--theme-color);
      border-radius: 20px;
      position: relative;
      overflow: hidden; /* ã¯ã¿å‡ºã—é˜²æ­¢ */
      box-shadow: 0 10px 30px rgba(0,0,0,0.1);
      touch-action: none; /* ãƒœãƒ¼ãƒ‰å†…ã§ã®ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«é˜²æ­¢ */
    }

    /* SVGãƒ¬ã‚¤ãƒ¤ãƒ¼ï¼ˆç·šã‚’æç”»ï¼‰ */
    #linesSvg {
      width: 100%;
      height: 100%;
      position: absolute;
      top: 0;
      left: 0;
      z-index: 0; /* ã‚­ãƒ£ãƒ©ã‚ˆã‚Šä¸‹ */
      pointer-events: none; /* ã‚¯ãƒªãƒƒã‚¯ã‚’é€é */
    }

    /* ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ã‚¢ã‚¤ã‚³ãƒ³ */
    .char-node {
      position: absolute;
      width: 80px;
      display: flex;
      flex-direction: column;
      align-items: center;
      cursor: grab;
      z-index: 10;
      user-select: none;
    }
    .char-node:active { cursor: grabbing; z-index: 20; }

    .char-img-box {
      width: 70px;
      height: 70px;
      border-radius: 50%;
      border: 3px solid #fff;
      box-shadow: 0 4px 8px rgba(0,0,0,0.2);
      overflow: hidden;
      background: #eee;
      position: relative;
    }
    .char-img-box img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }
    
    /* å‰Šé™¤ãƒœã‚¿ãƒ³ï¼ˆã‚­ãƒ£ãƒ©é¸æŠæ™‚ã®ã¿è¡¨ç¤ºãªã©ã®åˆ¶å¾¡ã‚‚å¯ã ãŒä»Šå›ã¯ç°¡æ˜“çš„ã«å¸¸æ™‚å³ä¸Šã«ï¼‰ */
    .btn-delete-char {
      position: absolute;
      top: -5px;
      right: 0;
      background: #ff6b6b;
      color: white;
      width: 20px;
      height: 20px;
      border-radius: 50%;
      text-align: center;
      line-height: 20px;
      font-size: 12px;
      cursor: pointer;
      display: none; /* ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆéè¡¨ç¤º */
    }
    .char-node:hover .btn-delete-char { display: block; } /* ãƒ›ãƒãƒ¼ã§è¡¨ç¤º */

    .char-name {
      background: rgba(255,255,255,0.9);
      padding: 2px 8px;
      border-radius: 10px;
      font-size: 0.8rem;
      margin-top: 5px;
      font-weight: bold;
      border: 1px solid #eee;
      max-width: 100%;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    /* ç·šä¸Šã®ãƒ©ãƒ™ãƒ« */
    .relation-label {
      position: absolute;
      background: #fff;
      border: 1px solid var(--theme-color);
      color: var(--theme-color);
      padding: 2px 8px;
      border-radius: 10px;
      font-size: 0.75rem;
      font-weight: bold;
      transform: translate(-50%, -50%); /* ä¸­å¿ƒã«é…ç½® */
      z-index: 5;
      white-space: nowrap;
      cursor: pointer;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    }

    /* é–¢ä¿‚è¿½åŠ ãƒ¢ãƒ¼ãƒ€ãƒ« */
    #relationModal {
      display: none;
      position: fixed;
      top: 0; left: 0; width: 100%; height: 100%;
      background: rgba(0,0,0,0.5);
      z-index: 100;
      justify-content: center;
      align-items: center;
    }
    .modal-content {
      background: #fff;
      padding: 20px;
      border-radius: 20px;
      width: 90%;
      max-width: 350px;
      text-align: center;
    }
    .modal-content h3 { color: var(--theme-color); margin-top: 0; }
    .modal-input {
      width: 100%; margin-bottom: 10px; padding: 8px;
      border: 2px solid #eee; border-radius: 8px; box-sizing: border-box;
    }
    .preset-btns {
      display: flex; gap: 5px; flex-wrap: wrap; justify-content: center; margin-bottom: 10px;
    }
    .preset-btn {
      background: #f0f0f0; border: none; padding: 5px 10px; border-radius: 15px; cursor: pointer; font-size: 0.8rem;
    }

    /* ä¿å­˜ãƒ»å…±æœ‰ã‚¨ãƒªã‚¢ */
    .save-share-area {
      margin-top: 20px;
      text-align: center;
      display: flex;
      gap: 15px;
      justify-content: center;
    }
    #longpressSaveArea { display: none; margin-top: 20px; text-align: center; }

    /* ãƒ•ãƒƒã‚¿ãƒ¼ */
    .ad-footer {
      text-align: center;
      padding: 20px;
      background: #fff;
      border-top: 3px dashed var(--theme-color);
      margin-top: 40px;
      width: 100%;
    }
    .footer-nav {
      position: fixed;
      bottom: 0; left: 0; width: 100%;
      background: rgba(255,255,255,0.95);
      padding: 12px;
      text-align: center;
      z-index: 999;
      box-shadow: 0 -2px 10px rgba(0,0,0,0.05);
      border-top: 2px solid var(--theme-color);
    }
    .footer-nav a { color: var(--theme-color); font-weight: bold; text-decoration: none; }

    /* é¸æŠä¸­ã®ã‚¹ã‚¿ã‚¤ãƒ« */
    .char-node.selected .char-img-box {
      border-color: #5a96ff;
      box-shadow: 0 0 10px #5a96ff;
    }

  </style>
</head>
<body>

  <h1>ğŸ§© ã‚ªãƒªã‚­ãƒ£ãƒ©ç›¸é–¢å›³ãƒ¡ãƒ¼ã‚«ãƒ¼</h1>

  <div class="controls">
    <!-- ç”»åƒè¿½åŠ ãƒœã‚¿ãƒ³ -->
    <label class="file-label">
      <input type="file" id="fileInput" accept="image/*" onchange="addCharacter(this)">
      <i class="fa-solid fa-plus"></i> ã‚­ãƒ£ãƒ©è¿½åŠ 
    </label>

    <!-- ç·šå¼•ããƒ¢ãƒ¼ãƒ‰åˆ‡ã‚Šæ›¿ãˆ -->
    <button class="btn btn-line" id="lineModeBtn" onclick="toggleLineMode()">
      <i class="fa-solid fa-link"></i> é–¢ä¿‚ã‚’çµã¶
    </button>

    <!-- èƒŒæ™¯è‰² -->
    <div style="display:flex; align-items:center; gap:5px; font-size:0.9rem;">
      èƒŒæ™¯: <input type="color" id="bgColorPicker" value="#ffffff" onchange="changeBoardColor(this.value)" style="width:30px; height:30px; border:none; cursor:pointer;">
    </div>

    <button class="btn btn-reset" onclick="resetBoard()"><i class="fa-solid fa-trash"></i> ãƒªã‚»ãƒƒãƒˆ</button>
  </div>

  <div style="font-size:0.8rem; margin-bottom:5px; color:#888;">
    â€»ã‚­ãƒ£ãƒ©ã‚’ãƒ‰ãƒ©ãƒƒã‚°ã§ç§»å‹•ã€ã‚¿ãƒƒãƒ—ã§åå‰å¤‰æ›´ã§ãã¾ã™
  </div>

  <!-- ç›¸é–¢å›³ãƒœãƒ¼ãƒ‰ -->
  <div id="boardContainer">
    <!-- ç·šã‚’æç”»ã™ã‚‹SVGãƒ¬ã‚¤ãƒ¤ãƒ¼ -->
    <svg id="linesSvg"></svg>
    <!-- ã“ã“ã«ã‚­ãƒ£ãƒ©(div)ãŒè¿½åŠ ã•ã‚Œã‚‹ -->
  </div>

  <!-- ä¿å­˜ãƒ»å…±æœ‰ -->
  <div class="save-share-area">
    <button class="btn btn-add" id="btn-save" onclick="saveImage()">
      <i class="fa-solid fa-camera"></i> ç”»åƒä¿å­˜
    </button>
    <button class="btn" style="background:#555;" onclick="nativeShare()">
      <i class="fa-solid fa-share-nodes"></i> å…±æœ‰
    </button>
  </div>

  <div id="longpressSaveArea"></div>

  <!-- é–¢ä¿‚å…¥åŠ›ãƒ¢ãƒ¼ãƒ€ãƒ« -->
  <div id="relationModal">
    <div class="modal-content">
      <h3>é–¢ä¿‚æ€§ã‚’å…¥åŠ›</h3>
      <input type="text" id="relationText" class="modal-input" placeholder="ä¾‹ï¼šè¦ªå‹ã€ãƒ©ã‚¤ãƒãƒ«">
      <div class="preset-btns">
        <button class="preset-btn" onclick="setInput('è¦ªå‹')">è¦ªå‹</button>
        <button class="preset-btn" onclick="setInput('æ‹äºº')">æ‹äºº</button>
        <button class="preset-btn" onclick="setInput('çŠ¬çŒ¿')">çŠ¬çŒ¿</button>
        <button class="preset-btn" onclick="setInput('ç›¸æ£’')">ç›¸æ£’</button>
        <button class="preset-btn" onclick="setInput('å®¶æ—')">å®¶æ—</button>
        <button class="preset-btn" onclick="setInput('ç‰‡æ€ã„')">ç‰‡æ€ã„</button>
      </div>
      <label style="font-size:0.9rem; font-weight:bold;">ç·šã®è‰²ï¼š</label>
      <input type="color" id="lineColorInput" value="#ffb7c5" style="width:100%; height:40px; margin-bottom:10px; cursor:pointer;">
      
      <div style="display:flex; justify-content:center; gap:10px;">
        <button class="btn btn-add" onclick="confirmRelation()">æ±ºå®š</button>
        <button class="btn btn-reset" onclick="closeModal()">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
      </div>
    </div>
  </div>

  <!-- ãƒ•ãƒƒã‚¿ãƒ¼ -->
  <footer class="ad-footer">
    <p style="color:var(--theme-color); font-weight:bold; margin-bottom:10px;">â™¡ å‰µä½œã®ãŠä¾›ã« â™¡</p>
    <div style="display:flex; justify-content:center; gap:10px; flex-wrap:wrap;">
      <script type="text/javascript">rakuten_design="slide";rakuten_affiliateId="47f67ba0.34b43d0d.47f67ba1.f8c0f51e";rakuten_items="ctsmatch";rakuten_genreId="0";rakuten_size="468x160";rakuten_target="_blank";rakuten_theme="gray";rakuten_border="off";rakuten_auto_mode="on";rakuten_genre_title="off";rakuten_recommend="on";rakuten_ts="1764908023168";</script><script type="text/javascript" src="https://xml.affiliate.rakuten.co.jp/widget/js/rakuten_widget.js?20230106"></script>
    </div>
  </footer>

  <div class="footer-nav">
    <a href="https://mofu-mitsu.github.io/">TOPã¸æˆ»ã‚‹</a>
  </div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <script>
    /* === åŸºæœ¬è¨­å®š === */
    let characters = []; // { id, x, y, name, img }
    let relationships = []; // { id, fromId, toId, text, color }
    let charIdCounter = 0;
    let lineIdCounter = 0;
    
    let isLineMode = false;
    let selectedCharId = null; // ç·šçµã³ç”¨

    const board = document.getElementById('boardContainer');
    const svg = document.getElementById('linesSvg');

    /* === ã‚­ãƒ£ãƒ©è¿½åŠ æ©Ÿèƒ½ === */
    function addCharacter(input) {
      const file = input.files[0];
      if (!file) return;

      const reader = new FileReader();
      reader.onload = function(e) {
        createCharacterNode(e.target.result);
        input.value = ''; // ãƒªã‚»ãƒƒãƒˆ
      };
      reader.readAsDataURL(file);
    }

    function createCharacterNode(imgSrc) {
      charIdCounter++;
      const id = `char-${charIdCounter}`;
      
      // ãƒ©ãƒ³ãƒ€ãƒ ãªåˆæœŸä½ç½®ï¼ˆãƒœãƒ¼ãƒ‰å†…ï¼‰
      const x = Math.random() * (board.clientWidth - 100);
      const y = Math.random() * (board.clientHeight - 100);

      // DOMä½œæˆ
      const node = document.createElement('div');
      node.className = 'char-node';
      node.id = id;
      node.style.left = x + 'px';
      node.style.top = y + 'px';
      
      // å‰Šé™¤ãƒœã‚¿ãƒ³
      const delBtn = document.createElement('div');
      delBtn.className = 'btn-delete-char';
      delBtn.innerText = 'Ã—';
      delBtn.onclick = (ev) => { ev.stopPropagation(); deleteCharacter(id); };

      // ç”»åƒãƒœãƒƒã‚¯ã‚¹
      const imgBox = document.createElement('div');
      imgBox.className = 'char-img-box';
      const img = document.createElement('img');
      img.src = imgSrc;
      imgBox.appendChild(img);

      // åå‰ãƒ©ãƒ™ãƒ«
      const nameLabel = document.createElement('div');
      nameLabel.className = 'char-name';
      nameLabel.innerText = 'åå‰å…¥åŠ›';
      nameLabel.onclick = (ev) => {
        ev.stopPropagation();
        if(!isLineMode) {
          const newName = prompt("ã‚­ãƒ£ãƒ©ã®åå‰ã‚’å…¥åŠ›ã—ã¦ã­", nameLabel.innerText);
          if(newName) nameLabel.innerText = newName;
        }
      };

      node.appendChild(delBtn);
      node.appendChild(imgBox);
      node.appendChild(nameLabel);
      board.appendChild(node);

      // ãƒ‡ãƒ¼ã‚¿ä¿å­˜
      characters.push({ id, element: node });

      // ãƒ‰ãƒ©ãƒƒã‚°ã‚¤ãƒ™ãƒ³ãƒˆè¨­å®š
      setupDraggable(node);
      
      // ã‚¯ãƒªãƒƒã‚¯ã‚¤ãƒ™ãƒ³ãƒˆï¼ˆç·šçµã³ç”¨ï¼‰
      node.addEventListener('click', () => handleCharClick(id));
    }

    /* === å‰Šé™¤æ©Ÿèƒ½ === */
    function deleteCharacter(id) {
      const index = characters.findIndex(c => c.id === id);
      if (index > -1) {
        // DOMå‰Šé™¤
        characters[index].element.remove();
        characters.splice(index, 1);
        
        // é–¢é€£ã™ã‚‹ç·šã‚‚å‰Šé™¤
        relationships = relationships.filter(r => {
          if (r.fromId === id || r.toId === id) {
            document.getElementById(r.id)?.remove(); // SVGç·šå‰Šé™¤
            document.getElementById('label-' + r.id)?.remove(); // ãƒ©ãƒ™ãƒ«å‰Šé™¤
            return false;
          }
          return true;
        });
      }
    }

    /* === ãƒ‰ãƒ©ãƒƒã‚°ç§»å‹•æ©Ÿèƒ½ (PC/ã‚¹ãƒãƒ›ä¸¡å¯¾å¿œ) === */
    function setupDraggable(el) {
      let isDragging = false;
      let startX, startY, initialLeft, initialTop;

      const startDrag = (e) => {
        if(isLineMode) return; // ç·šãƒ¢ãƒ¼ãƒ‰ä¸­ã¯ãƒ‰ãƒ©ãƒƒã‚°ä¸å¯
        isDragging = true;
        
        const clientX = e.type.includes('touch') ? e.touches[0].clientX : e.clientX;
        const clientY = e.type.includes('touch') ? e.touches[0].clientY : e.clientY;
        
        startX = clientX;
        startY = clientY;
        initialLeft = parseFloat(el.style.left || 0);
        initialTop = parseFloat(el.style.top || 0);
        
        // Z-indexã‚’ä¸Šã’ã¦æœ€å‰é¢ã«
        el.style.zIndex = 100;
      };

      const doDrag = (e) => {
        if (!isDragging) return;
        e.preventDefault(); // ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«é˜²æ­¢

        const clientX = e.type.includes('touch') ? e.touches[0].clientX : e.clientX;
        const clientY = e.type.includes('touch') ? e.touches[0].clientY : e.clientY;

        const dx = clientX - startX;
        const dy = clientY - startY;

        let newLeft = initialLeft + dx;
        let newTop = initialTop + dy;

        // æ å¤–ã«ã¯ã¿å‡ºã•ãªã„åˆ¶é™
        const maxW = board.clientWidth - el.offsetWidth;
        const maxH = board.clientHeight - el.offsetHeight;
        newLeft = Math.max(0, Math.min(newLeft, maxW));
        newTop = Math.max(0, Math.min(newTop, maxH));

        el.style.left = newLeft + 'px';
        el.style.top = newTop + 'px';

        // ç·šã®å†æç”»
        updateLines();
      };

      const stopDrag = () => {
        isDragging = false;
        el.style.zIndex = '';
      };

      el.addEventListener('mousedown', startDrag);
      el.addEventListener('touchstart', startDrag, {passive: false});
      
      window.addEventListener('mousemove', doDrag);
      window.addEventListener('touchmove', doDrag, {passive: false});
      
      window.addEventListener('mouseup', stopDrag);
      window.addEventListener('touchend', stopDrag);
    }

    /* === ç·šçµã³æ©Ÿèƒ½ === */
    function toggleLineMode() {
      isLineMode = !isLineMode;
      const btn = document.getElementById('lineModeBtn');
      if (isLineMode) {
        btn.classList.add('active');
        btn.innerHTML = '<i class="fa-solid fa-check"></i> çµ‚äº†';
        selectedCharId = null;
      } else {
        btn.classList.remove('active');
        btn.innerHTML = '<i class="fa-solid fa-link"></i> é–¢ä¿‚ã‚’çµã¶';
        // é¸æŠè§£é™¤
        if(selectedCharId) {
          document.getElementById(selectedCharId).classList.remove('selected');
          selectedCharId = null;
        }
      }
    }

    let tempFromId = null;
    let tempToId = null;

    function handleCharClick(id) {
      if (!isLineMode) return;

      const el = document.getElementById(id);

      if (!selectedCharId) {
        // 1äººç›®é¸æŠ
        selectedCharId = id;
        el.classList.add('selected');
      } else {
        // 2äººç›®é¸æŠï¼ˆè‡ªåˆ†è‡ªèº«ä»¥å¤–ï¼‰
        if (selectedCharId !== id) {
          tempFromId = selectedCharId;
          tempToId = id;
          
          // é¸æŠè§£é™¤
          document.getElementById(selectedCharId).classList.remove('selected');
          selectedCharId = null;

          // ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‹ã
          openModal();
        } else {
          // ã‚­ãƒ£ãƒ³ã‚»ãƒ«ï¼ˆè‡ªåˆ†ã‚’ã‚¯ãƒªãƒƒã‚¯ï¼‰
          el.classList.remove('selected');
          selectedCharId = null;
        }
      }
    }

    /* === ãƒ¢ãƒ¼ãƒ€ãƒ«é–¢é€£ === */
    const modal = document.getElementById('relationModal');
    const relationInput = document.getElementById('relationText');
    const colorInput = document.getElementById('lineColorInput');

    function openModal() {
      relationInput.value = '';
      modal.style.display = 'flex';
    }
    
    function closeModal() {
      modal.style.display = 'none';
      tempFromId = null;
      tempToId = null;
    }

    function setInput(text) {
      relationInput.value = text;
    }

    function confirmRelation() {
      const text = relationInput.value || 'é–¢ä¿‚';
      const color = colorInput.value;
      createLine(tempFromId, tempToId, text, color);
      closeModal();
    }

    /* === ç·šã®æç”»ãƒ»ç®¡ç† === */
    function createLine(fromId, toId, text, color) {
      lineIdCounter++;
      const id = `line-${lineIdCounter}`;

      // SVGç·šä½œæˆ
      const line = document.createElementNS('http://www.w3.org/2000/svg', 'line');
      line.setAttribute('id', id);
      line.setAttribute('stroke', color);
      line.setAttribute('stroke-width', '3');
      line.setAttribute('stroke-linecap', 'round');
      svg.appendChild(line);

      // ãƒ©ãƒ™ãƒ«ä½œæˆï¼ˆHTMLè¦ç´ ï¼‰
      const label = document.createElement('div');
      label.className = 'relation-label';
      label.id = 'label-' + id;
      label.innerText = text;
      label.style.borderColor = color;
      label.style.color = color;
      
      // ãƒ©ãƒ™ãƒ«ã‚¯ãƒªãƒƒã‚¯ã§å‰Šé™¤
      label.onclick = () => {
        if(confirm('ã“ã®é–¢ä¿‚ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) {
          deleteLine(id);
        }
      };
      
      board.appendChild(label);

      relationships.push({ id, fromId, toId, text, color, lineEl: line, labelEl: label });
      updateLines();
    }

    function deleteLine(id) {
      const index = relationships.findIndex(r => r.id === id);
      if(index > -1) {
        document.getElementById(id).remove();
        document.getElementById('label-' + id).remove();
        relationships.splice(index, 1);
      }
    }

    function updateLines() {
      relationships.forEach(rel => {
        const fromEl = document.getElementById(rel.fromId);
        const toEl = document.getElementById(rel.toId);
        if (!fromEl || !toEl) return;

        // ä¸­å¿ƒã®åº§æ¨™ã‚’è¨ˆç®—
        const x1 = fromEl.offsetLeft + fromEl.offsetWidth / 2;
        const y1 = fromEl.offsetTop + fromEl.offsetHeight / 2;
        const x2 = toEl.offsetLeft + toEl.offsetWidth / 2;
        const y2 = toEl.offsetTop + toEl.offsetHeight / 2;

        // ç·šæ›´æ–°
        rel.lineEl.setAttribute('x1', x1);
        rel.lineEl.setAttribute('y1', y1);
        rel.lineEl.setAttribute('x2', x2);
        rel.lineEl.setAttribute('y2', y2);

        // ãƒ©ãƒ™ãƒ«ä½ç½®æ›´æ–°ï¼ˆä¸­ç‚¹ï¼‰
        rel.labelEl.style.left = (x1 + x2) / 2 + 'px';
        rel.labelEl.style.top = (y1 + y2) / 2 + 'px';
      });
    }

    /* === ãã®ä»–æ©Ÿèƒ½ === */
    function changeBoardColor(color) {
      document.getElementById('boardContainer').style.background = color;
    }

    function resetBoard() {
      if(!confirm('å…¨ã¦ãƒªã‚»ãƒƒãƒˆã—ã¾ã™ã‹ï¼Ÿ')) return;
      board.innerHTML = '<svg id="linesSvg"></svg>'; // SVGå†ç”Ÿæˆ
      characters = [];
      relationships = [];
      charIdCounter = 0;
      lineIdCounter = 0;
      isLineMode = false;
      document.getElementById('lineModeBtn').classList.remove('active');
    }

    /* === ä¿å­˜ãƒ»å…±æœ‰ === */
    function saveImage() {
      const btn = document.getElementById('btn-save');
      const originalText = btn.innerHTML;
      btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> ä½œæˆä¸­...';

      // html2canvasã®è¨­å®šï¼ˆSVGå¯¾å¿œã®ãŸã‚ï¼‰
      html2canvas(document.getElementById('boardContainer'), {
        scale: 2,
        backgroundColor: null
      }).then(canvas => {
        const dataURL = canvas.toDataURL('image/png');
        const isMobile = /iPhone|iPad|iPod|Android/i.test(navigator.userAgent);

        if (isMobile) {
          const area = document.getElementById('longpressSaveArea');
          area.innerHTML = '';
          const img = document.createElement('img');
          img.src = dataURL;
          img.style.width = '100%';
          img.style.borderRadius = '10px';
          img.style.boxShadow = '0 5px 15px rgba(0,0,0,0.1)';
          const msg = document.createElement('p');
          msg.innerHTML = 'â˜ï¸ <strong>ç”»åƒã‚’é•·æŠ¼ã—ã—ã¦ä¿å­˜</strong>ã—ã¦ã­ï¼';
          msg.style.color = '#ff9a9e';
          area.appendChild(msg);
          area.appendChild(img);
          area.style.display = 'block';
          area.scrollIntoView({behavior: 'smooth'});
        } else {
          const link = document.createElement('a');
          link.href = dataURL;
          link.download = `soukanzu-${Date.now()}.png`;
          link.click();
        }
        btn.innerHTML = originalText;
      });
    }

    function nativeShare() {
      if (navigator.share) {
        navigator.share({
          title: 'ã‚ªãƒªã‚­ãƒ£ãƒ©ç›¸é–¢å›³ãƒ¡ãƒ¼ã‚«ãƒ¼',
          text: 'ã†ã¡ã®å­ã®é–¢ä¿‚æ€§ã‚’ã¾ã¨ã‚ã¾ã—ãŸï¼ #ã‚ªãƒªã‚­ãƒ£ãƒ©ç›¸é–¢å›³ãƒ¡ãƒ¼ã‚«ãƒ¼',
          url: location.href
        });
      } else {
        alert('URLã‚’ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸï¼');
        navigator.clipboard.writeText(location.href);
      }
    }
  </script>
</body>
</html>